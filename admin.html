<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>لوحة التحكم – شجرة آل عبدالله</title>


<style>
body {
  font-family: sans-serif;
  background: #eef5e3;
  padding: 20px;
}
.container {
  max-width: 1000px;
  margin: auto;
  background: white;
  padding: 25px;
  border-radius: 15px;
  box-shadow: 0 3px 12px rgba(0,0,0,0.15);
}

h2, h3 { margin-top: 0; }

input, textarea, select {
  width: 100%;
  padding: 10px;
  margin: 6px 0;
  border-radius: 8px;
  border: 1px solid #bbb;
  font-size: 14px;
}

textarea { min-height: 80px; }

button {
  background: #2e7d32;
  color: white;
  padding: 10px 16px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  margin-top: 10px;
}
button:hover { background: #1b5e20; }

.flex {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
}

.col { flex: 1 1 300px; }

.person {
  background: #e8f4d9;
  padding: 10px;
  border-radius: 10px;
  margin-bottom: 8px;
}

.person img {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  object-fit: cover;
}

.person-info {
  font-size: 13px;
  margin-top: 5px;
}

.tree-box {
  background: #f4fbec;
  padding: 10px;
  border-radius: 10px;
}

#jsonOutput {
  width: 100%;
  height: 200px;
  margin-top: 10px;
  font-family: monospace;
}
</style>
</head>

<body>
  
<a href="index.html" class="back-btn">← الرجوع للموقع</a>

<div class="container">
  <h2>لوحة التحكم – شجرة آل عبدالله</h2>

  <div class="flex">
    <!-- نموذج إضافة/تعديل -->
    <div class="col">
      <h3>إضافة / تعديل شخص</h3>

      <input type="hidden" id="editId">

      <label>الاسم:</label>
      <input id="name" placeholder="اسم الشخص">

      <label>المواليد:</label>
      <input id="birth" placeholder="مثال: 1980">

      <label>الوظيفة:</label>
      <input id="job" placeholder="الوظيفة">

      <label>الوصف:</label>
      <textarea id="desc" placeholder="وصف للشخص"></textarea>

      <label>رفع صورة:</label>
      <input type="file" id="photoFile" accept="image/*">
      <img id="photoPreview" style="width:120px;height:120px;border-radius:50%;margin-top:5px;object-fit:cover;">

      <label>اختيار الأب:</label>
      <select id="fatherId">
        <option value="">بدون أب (أصل)</option>
      </select>

      <button onclick="savePerson()">حفظ</button>
      <button onclick="resetForm()" style="background:#c62828;">مسح النموذج</button>
    </div>

    <!-- قائمة الأشخاص -->
    <div class="col">
      <h3>الأشخاص:</h3>
      <div id="list"></div>
    </div>
  </div>

  <hr>

  <h3>شجرة العائلة (عرض مبسط):</h3>
  <div id="tree" class="tree-box"></div>

  <hr>

  <h3>تصدير people.json</h3>
  <button onclick="downloadJSON()">تنزيل people.json</button>
  <button onclick="syncToGitHub()">حفظ في GitHub</button>
  <textarea id="jsonOutput" readonly></textarea>

</div>

<script>
let people = [];
let currentImageData = "";

// تحميل people.json الحقيقي
fetch("people.json")
  .then(res => res.json())
  .then(data => {
    people = data;
    renderList();
    fillFatherSelect();
    updateJSON();
    renderTree();
  });

// رفع الصورة → Base64
document.getElementById("photoFile").addEventListener("change", function(e){
  let file = e.target.files[0];
  if (!file) return;
  let reader = new FileReader();
  reader.onload = () => {
    currentImageData = reader.result;
    document.getElementById("photoPreview").src = reader.result;
  };
  reader.readAsDataURL(file);
});

// حفظ شخص (إضافة أو تعديل)
function savePerson() {
  let id = document.getElementById("editId").value;
  let name = document.getElementById("name").value.trim();

  if (!name) return alert("الاسم مطلوب!");

  let person = {
    id: id ? Number(id) : Date.now(),
    name,
    birth: document.getElementById("birth").value,
    job: document.getElementById("job").value,
    description: document.getElementById("desc").value,
    image: currentImageData,
    fatherId: document.getElementById("fatherId").value || null
  };

  if (id) {
    // تعديل
    let index = people.findIndex(p => p.id == id);
    people[index] = person;
  } else {
    // إضافة
    people.push(person);
  }

  resetForm();
  renderList();
  fillFatherSelect();
  updateJSON();
  renderTree();
}

// بدء التعديل
function editPerson(id) {
  let p = people.find(x => x.id == id);
  if (!p) return;

  document.getElementById("editId").value = p.id;
  document.getElementById("name").value = p.name;
  document.getElementById("birth").value = p.birth || "";
  document.getElementById("job").value = p.job || "";
  document.getElementById("desc").value = p.description || "";
  document.getElementById("fatherId").value = p.fatherId || "";
  currentImageData = p.image || "";
  document.getElementById("photoPreview").src = p.image || "";
}

// حذف شخص
function deletePerson(id) {
  if (!confirm("متأكد من الحذف؟")) return;
  people = people.filter(p => p.id != id);
  renderList();
  fillFatherSelect();
  updateJSON();
  renderTree();
}

// إعادة ضبط النموذج
function resetForm() {
  document.getElementById("editId").value = "";
  document.getElementById("name").value = "";
  document.getElementById("birth").value = "";
  document.getElementById("job").value = "";
  document.getElementById("desc").value = "";
  document.getElementById("fatherId").value = "";
  currentImageData = "";
  document.getElementById("photoPreview").src = "";
}

// عرض القائمة
function renderList() {
  let box = document.getElementById("list");
  box.innerHTML = "";

  if (!people.length) {
    box.innerHTML = "<p>لا يوجد أفراد بعد.</p>";
    return;
  }

  people.forEach(p => {
    box.innerHTML += `
      <div class="person">
        <img src="${p.image || ''}">
        <div class="person-info">
          <strong>${p.name}</strong><br>
          المواليد: ${p.birth || "-"}<br>
          الوظيفة: ${p.job || "-"}<br>
          الأب: ${getFatherName(p.fatherId)}
        </div>
        <button onclick="editPerson(${p.id})">تعديل</button>
        <button onclick="deletePerson(${p.id})" style="background:#c62828;">حذف</button>
      </div>
    `;
  });
}

// اسم الأب
function getFatherName(id) {
  let p = people.find(x => x.id == id);
  return p ? p.name : "—";
}

// تعبئة قائمة الآباء
function fillFatherSelect() {
  let sel = document.getElementById("fatherId");
  sel.innerHTML = '<option value="">بدون أب (أصل)</option>';
  people.forEach(p => {
    sel.innerHTML += `<option value="${p.id}">${p.name}</option>`;
  });
}

// تحديث JSON في المربع
function updateJSON() {
  document.getElementById("jsonOutput").value = JSON.stringify(people, null, 2);
}

// تنزيل الملف
function downloadJSON() {
  let blob = new Blob([JSON.stringify(people, null, 2)], {type:"application/json"});
  let url = URL.createObjectURL(blob);
  let a = document.createElement("a");
  a.href = url;
  a.download = "people.json";
  a.click();
}

// عرض شجرة بسيطة
function renderTree() {
  let tree = document.getElementById("tree");
  tree.innerHTML = "";

  let roots = people.filter(a => !a.fatherId);

  if (!roots.length) {
    tree.innerHTML = "<p>لا يوجد جذور (أشخاص بدون أب).</p>";
    return;
  }

  roots.forEach(root => {
    tree.innerHTML += `<h4>${root.name}</h4>`;

    let children = people.filter(a => a.fatherId == root.id);
    children.forEach(ch => {
      tree.innerHTML += `— ابن: ${ch.name}<br>`;
      let gc = people.filter(a => a.fatherId == ch.id);
      gc.forEach(g => {
        tree.innerHTML += `------ حفيد: ${g.name}<br>`;
      });
    });

    tree.innerHTML += "<br>";
  });
}

// حفظ في GitHub عبر API
async function syncToGitHub() {
  try {
    const res = await fetch('/api/update-people', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content: people })
    });

    if (res.ok) {
      alert('تم الحفظ في GitHub بنجاح ✅');
    } else {
      const txt = await res.text();
      console.error(txt);
      alert('صار خطأ أثناء الحفظ في GitHub ❌');
    }
  } catch (e) {
    console.error(e);
    alert('تعذر الاتصال بـ API ❌');
  }
}
</script>

</body>
</html>

<style>
  .back-btn {
  display: inline-block;
  background: #2e7d32;
  color: white;
  padding: 12px 20px;
  border-radius: 10px;
  font-weight: bold;
  text-decoration: none;
  font-size: 18px;
  margin-bottom: 20px;
}

.back-btn:hover {
  background: #1b5e20;
}
</style>
